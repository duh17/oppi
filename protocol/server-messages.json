{
  "_meta": {
    "description": "Canonical ServerMessage JSON — generated by server/tests/protocol-snapshots.test.ts",
    "generated": "2026-02-21T06:54:38.236Z",
    "messageCount": 33
  },
  "messages": {
    "connected": {
      "type": "connected",
      "session": {
        "id": "test-session-1",
        "workspaceId": "ws-1",
        "workspaceName": "My Workspace",
        "name": "Test Session",
        "status": "ready",
        "createdAt": 1739750400000,
        "lastActivity": 1739750460000,
        "model": "anthropic/claude-sonnet-4-20250514",
        "messageCount": 5,
        "tokens": {
          "input": 1500,
          "output": 800
        },
        "cost": 0.012,
        "changeStats": {
          "mutatingToolCalls": 3,
          "filesChanged": 6,
          "changedFiles": [
            "src/main.ts",
            "README.md"
          ],
          "changedFilesOverflow": 4,
          "addedLines": 45,
          "removedLines": 12
        },
        "contextTokens": 2300,
        "contextWindow": 200000,
        "lastMessage": "I've updated the README with the new API docs.",
        "thinkingLevel": "high",
        "piSessionFile": "/tmp/pi-sessions/abc123.jsonl",
        "piSessionFiles": [
          "/tmp/pi-sessions/abc123.jsonl"
        ],
        "piSessionId": "uuid-abc-123"
      },
      "currentSeq": 42
    },
    "stream_connected": {
      "type": "stream_connected",
      "userName": "mac-studio"
    },
    "state": {
      "type": "state",
      "session": {
        "id": "test-session-1",
        "workspaceId": "ws-1",
        "workspaceName": "My Workspace",
        "name": "Test Session",
        "status": "ready",
        "createdAt": 1739750400000,
        "lastActivity": 1739750460000,
        "model": "anthropic/claude-sonnet-4-20250514",
        "messageCount": 5,
        "tokens": {
          "input": 1500,
          "output": 800
        },
        "cost": 0.012,
        "changeStats": {
          "mutatingToolCalls": 3,
          "filesChanged": 6,
          "changedFiles": [
            "src/main.ts",
            "README.md"
          ],
          "changedFilesOverflow": 4,
          "addedLines": 45,
          "removedLines": 12
        },
        "contextTokens": 2300,
        "contextWindow": 200000,
        "lastMessage": "I've updated the README with the new API docs.",
        "thinkingLevel": "high",
        "piSessionFile": "/tmp/pi-sessions/abc123.jsonl",
        "piSessionFiles": [
          "/tmp/pi-sessions/abc123.jsonl"
        ],
        "piSessionId": "uuid-abc-123"
      }
    },
    "session_ended": {
      "type": "session_ended",
      "reason": "Process exited with code 0"
    },
    "stop_requested": {
      "type": "stop_requested",
      "source": "user",
      "reason": "User pressed stop"
    },
    "stop_confirmed": {
      "type": "stop_confirmed",
      "source": "user",
      "reason": "Session stopped gracefully"
    },
    "stop_failed": {
      "type": "stop_failed",
      "source": "timeout",
      "reason": "Process did not respond to SIGTERM within 10s"
    },
    "error": {
      "type": "error",
      "error": "Model API rate limit exceeded",
      "code": "rate_limit",
      "fatal": false
    },
    "agent_start": {
      "type": "agent_start"
    },
    "agent_end": {
      "type": "agent_end"
    },
    "turn_start": {
      "type": "turn_start"
    },
    "turn_end": {
      "type": "turn_end"
    },
    "message_end": {
      "type": "message_end",
      "role": "assistant",
      "content": "I've finished updating the code."
    },
    "text_delta": {
      "type": "text_delta",
      "delta": "Hello, "
    },
    "thinking_delta": {
      "type": "thinking_delta",
      "delta": "Let me analyze..."
    },
    "tool_start": {
      "type": "tool_start",
      "tool": "bash",
      "args": {
        "command": "npm test"
      },
      "toolCallId": "tc-001"
    },
    "tool_start_with_segments": {
      "type": "tool_start",
      "tool": "read",
      "args": {
        "path": "src/main.ts",
        "offset": 1,
        "limit": 50
      },
      "toolCallId": "tc-seg-001",
      "callSegments": [
        {
          "text": "read ",
          "style": "bold"
        },
        {
          "text": "src/main.ts",
          "style": "accent"
        },
        {
          "text": ":1-50",
          "style": "warning"
        }
      ]
    },
    "tool_output": {
      "type": "tool_output",
      "output": "All 42 tests passed",
      "isError": false,
      "toolCallId": "tc-001"
    },
    "tool_end": {
      "type": "tool_end",
      "tool": "bash",
      "toolCallId": "tc-001"
    },
    "tool_end_with_details": {
      "type": "tool_end",
      "tool": "remember",
      "toolCallId": "tc-ext-001",
      "details": {
        "file": "2026-02-18.md",
        "redacted": false
      },
      "isError": false,
      "resultSegments": [
        {
          "text": "✓ Saved",
          "style": "success"
        },
        {
          "text": " → 2026-02-18.md",
          "style": "muted"
        }
      ]
    },
    "turn_ack": {
      "type": "turn_ack",
      "command": "prompt",
      "clientTurnId": "turn-abc-123",
      "stage": "accepted",
      "requestId": "req-001",
      "duplicate": false
    },
    "rpc_result_success": {
      "type": "rpc_result",
      "command": "get_state",
      "requestId": "req-002",
      "success": true,
      "data": {
        "model": {
          "provider": "anthropic",
          "id": "claude-sonnet-4-0"
        }
      }
    },
    "rpc_result_error": {
      "type": "rpc_result",
      "command": "set_model",
      "requestId": "req-003",
      "success": false,
      "error": "Model not found"
    },
    "compaction_start": {
      "type": "compaction_start",
      "reason": "Context window 85% full"
    },
    "compaction_end": {
      "type": "compaction_end",
      "aborted": false,
      "willRetry": false,
      "summary": "Compacted 15k tokens to 8k tokens",
      "tokensBefore": 15000
    },
    "retry_start": {
      "type": "retry_start",
      "attempt": 1,
      "maxAttempts": 3,
      "delayMs": 5000,
      "errorMessage": "API overloaded"
    },
    "retry_end": {
      "type": "retry_end",
      "success": true,
      "attempt": 2
    },
    "permission_request": {
      "type": "permission_request",
      "id": "perm-001",
      "sessionId": "test-session-1",
      "tool": "bash",
      "input": {
        "command": "rm -rf node_modules"
      },
      "displaySummary": "Run: rm -rf node_modules",
      "reason": "Destructive file operation",
      "timeoutAt": 1739750520000,
      "expires": true
    },
    "permission_expired": {
      "type": "permission_expired",
      "id": "perm-002",
      "reason": "Approval timeout (30s)"
    },
    "permission_cancelled": {
      "type": "permission_cancelled",
      "id": "perm-003"
    },
    "extension_ui_request": {
      "type": "extension_ui_request",
      "id": "ui-001",
      "sessionId": "test-session-1",
      "method": "select",
      "title": "Choose a model",
      "options": [
        "claude-sonnet",
        "claude-opus"
      ],
      "message": "Select the model for this task",
      "placeholder": "Select...",
      "prefill": "claude-sonnet",
      "timeout": 30000
    },
    "extension_ui_notification": {
      "type": "extension_ui_notification",
      "method": "notify",
      "message": "Build completed successfully",
      "notifyType": "success",
      "statusKey": "build",
      "statusText": "✅ Build passed"
    },
    "git_status": {
      "type": "git_status",
      "workspaceId": "ws-1",
      "status": {
        "isGitRepo": true,
        "branch": "main",
        "headSha": "a1b2c3d",
        "ahead": 1,
        "behind": 0,
        "dirtyCount": 1,
        "untrackedCount": 0,
        "stagedCount": 1,
        "files": [
          {
            "status": "A",
            "path": "src/main.ts"
          },
          {
            "status": "M",
            "path": "README.md"
          }
        ],
        "totalFiles": 2,
        "stashCount": 0,
        "lastCommitMessage": "Initial commit",
        "lastCommitDate": "2026-02-20T18:00:00.000Z"
      }
    }
  }
}
