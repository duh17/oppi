#!/usr/bin/env bash
# Pre-commit hook: type-check + lint for pi-remote and ios
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

# Check which files are staged
STAGED=$(git diff --cached --name-only --diff-filter=ACM)

errors=0

# --- pi-remote checks ---
if echo "$STAGED" | grep -q "^pi-remote/src/"; then
  echo -e "${YELLOW}[pi-remote]${NC} Checking TypeScript..."

  cd pi-remote

  # Type check
  if ! npx tsc --noEmit 2>/dev/null; then
    echo -e "${RED}[pi-remote] tsc failed${NC}"
    errors=1
  fi

  # Lint (errors only — warnings don't block commit)
  if ! npx eslint src/ --max-warnings=-1 --quiet 2>/dev/null; then
    echo -e "${RED}[pi-remote] eslint found errors${NC}"
    errors=1
  fi

  # Format check
  if ! npx prettier --check src/ 2>/dev/null; then
    echo -e "${YELLOW}[pi-remote] prettier: run 'npm run format' to fix${NC}"
    # Don't block on formatting — just warn
  fi

  cd ..
fi

# --- iOS checks ---
if echo "$STAGED" | grep -q "^ios/.*\.swift$"; then
  echo -e "${YELLOW}[ios]${NC} Checking Swift..."

  if command -v swiftlint >/dev/null 2>&1; then
    cd ios
    # Only errors block commit (exit code 2 = errors present)
    if ! swiftlint lint --config .swiftlint.yml --quiet 2>/dev/null; then
      echo -e "${RED}[ios] swiftlint found errors${NC}"
      errors=1
    fi
    cd ..
  else
    echo -e "${YELLOW}[ios] swiftlint not installed — skipping${NC}"
  fi
fi

if [ "$errors" -ne 0 ]; then
  echo -e "${RED}Pre-commit checks failed. Fix errors before committing.${NC}"
  exit 1
fi

echo -e "${GREEN}Pre-commit checks passed.${NC}"
