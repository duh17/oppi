# CI lanes:
# - PR/push: server PR-fast gate + iOS test suite
# - Nightly: server nightly-deep gate
#
# Self-hosted runner on Mac Studio.
# Release to TestFlight is manual via ios/scripts/release.sh.

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 10 * * *'

concurrency:
  group: ci
  cancel-in-progress: true

env:
  PATH: /opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin

jobs:
  test:
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      # ── Server ──────────────────────────────────────────────

      - name: "Server: install"
        working-directory: server
        run: npm ci

      - name: "Server: testing gate"
        working-directory: server
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            npm run test:gate:nightly-deep
          else
            npm run test:gate:pr-fast
          fi

      # ── iOS ─────────────────────────────────────────────────

      - name: "iOS: generate project"
        if: github.event_name != 'schedule'
        working-directory: ios
        run: xcodegen generate

      - name: "iOS: unit tests"
        if: github.event_name != 'schedule'
        working-directory: ios
        run: |
          xcodebuild test \
            -project Oppi.xcodeproj \
            -scheme Oppi \
            -destination 'platform=iOS Simulator,OS=26.0,name=iPhone 16 Pro' \
            -only-testing:OppiTests \
            -derivedDataPath build/ci \
            -quiet

      - name: "iOS: UI tests"
        if: github.event_name != 'schedule'
        working-directory: ios
        run: |
          xcodebuild test \
            -project Oppi.xcodeproj \
            -scheme Oppi \
            -destination 'platform=iOS Simulator,OS=26.0,name=iPhone 16 Pro' \
            -only-testing:OppiUITests \
            -derivedDataPath build/ci \
            -quiet
